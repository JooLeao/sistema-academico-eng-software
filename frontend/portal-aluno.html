<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal do Aluno - Sistema Acadêmico</title>
    <link rel="stylesheet" href="/css/style-portal-aluno.css">
    <link rel="icon" href="/imagens/logo-engenharia.png" type="image/png">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-header">
                <img src="/imagens/logo-engenharia.png" alt="Logo Engenharia Software">
                <div class="logo-text">
                    <h1>Sistema Acadêmico</h1>
                    <p>Engenharia de Software</p>
                </div>
            </div>
            <div class="header-actions">
                <span id="userName" style="color: #eee; font-weight: 500; margin-right: 1rem;">Olá, Aluno!</span>
                <button class="btn-logout" id="logoutBtn">Sair</button>
            </div>
        </div>
    </header>

    <div class="main-layout">
        <aside class="sidebar">
            <div class="user-info">
                <h3 id="sidebarUserName"></h3>
                <p id="sidebarUserEmail"></p>
                <p id="sidebarUserType"></p>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" data-section="inicio" class="active">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg>
                    Página Inicial
                </a></li>
                <li><a href="#" data-section="boletim">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path></svg>
                    Boletim
                </a></li>
                <li><a href="#" data-section="matricula">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                    Matrícula
                </a></li>
                <li><a href="#" data-section="alterar-senha">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-2c0-1.66-1.34-3-3-3V9c0-1.1-.9-2-2-2h-2c-1.1 0-2 .9-2 2v1c-1.66 0-3 1.34-3 3s1.34 3 3 3v1h-1c-.55 0-1 .45-1 1s.45 1 1 1h12c.55 0 1-.45 1-1s-.45-1-1-1h-1zM9 9h6v1H9V9z"></path></svg>
                    Alterar Senha
                </a></li>
                <li><a href="#" data-section="calendario">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"></path></svg>
                    Calendário
                </a></li>
            </ul>
        </aside>

        <main class="content-area">
            <section id="inicio" class="content-section active">
                <h2>Página Inicial</h2>
                <div class="info-cards-grid">
                    <div class="info-card">
                        <h3><svg viewBox="0 0 24 24" width="24" height="24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg> Meu Perfil</h3>
                        <p><strong>Nome:</strong> <span id="homeUserName"></span></p>
                        <p><strong>Email:</strong> <span id="homeUserEmail"></span></p>
                        <p><strong>Tipo:</strong> <span id="homeUserType"></span></p>
                        <p><strong>Matrícula:</strong> <span id="homeUserMatricula">N/A</span></p>
                        <p><strong>Curso:</strong> <span id="homeUserCurso">N/A</span></p>
                        <p><strong>Período:</strong> <span id="homeUserPeriodo">N/A</span></p>
                    </div>
                    <div class="info-card">
                        <h3><svg viewBox="0 0 24 24" width="24" height="24"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"></path></svg> Próximos Eventos</h3>
                        <p>Fique atento às datas importantes do calendário acadêmico.</p>
                        <p>Ex: <span class="highlight">Reunião de Turma:</span> 05/JUL (Sala B2)</p>
                        <p>Ex: <span class="highlight">Prazo Entrega Projeto:</span> 15/JUL</p>
                    </div>
                    <div class="info-card">
                        <h3><svg viewBox="0 0 24 24" width="24" height="24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path></svg> Notas Recentes</h3>
                        <p>Verifique suas últimas avaliações e média por disciplina.</p>
                        <p>Ex: <span class="highlight">BD I (Nota 1):</span> 8.5</p>
                        <p>Ex: <span class="highlight">ES (Média Final):</span> 7.75</p>
                    </div>
                </div>
            </section>

            <section id="boletim" class="content-section">
                <h2>Boletim</h2>
                <table class="boletim-table">
                    <thead>
                        <tr>
                            <th>Disciplina</th>
                            <th>Nota 1</th>
                            <th>Nota 2</th>
                            <th>Média Final</th>
                            <th>Frequência (%)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Engenharia de Software</td>
                            <td>8.5</td>
                            <td>7.0</td>
                            <td>7.75</td>
                            <td>90</td>
                            <td class="status-aprovado">Aprovado</td>
                        </tr>
                        <tr>
                            <td>Banco de Dados I</td>
                            <td>7.0</td>
                            <td>6.5</td>
                            <td>6.75</td>
                            <td>85</td>
                            <td class="status-cursando">Cursando</td>
                        </tr>
                        <tr>
                            <td>Programação Orientada a Objetos</td>
                            <td>5.0</td>
                            <td>4.0</td>
                            <td>4.5</td>
                            <td>70</td>
                            <td class="status-reprovado">Reprovado</td>
                        </tr>
                        </tbody>
                </table>
            </section>

            <section id="matricula" class="content-section">
                <h2>Minha Matrícula</h2>
                <div class="matricula-details">
                    <p><strong>Status Geral:</strong> <span class="highlight">Ativo</span></p>
                    <p><strong>Número de Matrícula:</strong> <span id="matriculaNum">N/A</span></p>
                    <p><strong>Curso:</strong> <span id="matriculaCurso">N/A</span></p>
                    <p><strong>Período Atual:</strong> <span id="matriculaPeriodo">N/A</span></p>
                    <p><strong>Disciplinas Atuais:</strong></p>
                    <ul>
                        <li>Banco de Dados I (Turma 2025.1)</li>
                        <li>Redes de Computadores (Turma 2025.1)</li>
                    </ul>
                    <p style="margin-top: 1rem;">Para informações detalhadas sobre sua matrícula ou para realizar ajustes, entre em contato com a secretaria.</p>
                </div>
            </section>

            <section id="alterar-senha" class="content-section">
                <h2>Alterar Senha</h2>
                <form id="formAlterarSenha" class="form-alterar-senha">
                    <label for="currentPassword">Senha Atual:</label>
                    <input type="password" id="currentPassword" required>
                    
                    <label for="newPassword">Nova Senha:</label>
                    <input type="password" id="newPassword" required>
                    
                    <label for="confirmNewPassword">Confirmar Nova Senha:</label>
                    <input type="password" id="confirmNewPassword" required>
                    
                    <button type="submit">Alterar Senha</button>
                    <div id="senhaMessage" style="display: none;"></div>
                </form>
            </section>

            <section id="calendario" class="content-section">
                <h2>Calendário Acadêmico</h2>
                <div class="calendar">
                    <div class="calendar-header">
                        <button id="prevMonthBtn">←</button>
                        <span id="currentMonthYear">Junho 2025</span>
                        <button id="nextMonthBtn">→</button>
                    </div>
                    <div class="calendar-grid">
                        <div class="calendar-day-name">Dom</div>
                        <div class="calendar-day-name">Seg</div>
                        <div class="calendar-day-name">Ter</div>
                        <div class="calendar-day-name">Qua</div>
                        <div class="calendar-day-name">Qui</div>
                        <div class="calendar-day-name">Sex</div>
                        <div class="calendar-day-name">Sáb</div>
                        </div>
                    <p style="margin-top: 1.5rem; text-align: center; color: #555;">
                        <span style="display: inline-block; width: 15px; height: 15px; border: 2px solid #dc3545; border-radius: 3px; vertical-align: middle; margin-right: 5px;"></span> = Dia com Evento
                    </p>
                </div>
            </section>
        </main>
    </div>

    

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Seletores de elementos da UI
        const userNameDisplay = document.getElementById('userName');
        const sidebarUserName = document.getElementById('sidebarUserName');
        const sidebarUserEmail = document.getElementById('sidebarUserEmail');
        const sidebarUserType = document.getElementById('sidebarUserType');
        const homeUserName = document.getElementById('homeUserName');
        const homeUserEmail = document.getElementById('homeUserEmail');
        const homeUserType = document.getElementById('homeUserType');
        const homeUserMatricula = document.getElementById('homeUserMatricula');
        const homeUserCurso = document.getElementById('homeUserCurso');
        const homeUserPeriodo = document.getElementById('homeUserPeriodo');
        const logoutBtn = document.getElementById('logoutBtn');
        const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
        const contentSections = document.querySelectorAll('.content-section');
        const boletimTableBody = document.querySelector('#boletim .boletim-table tbody');

        // --- Verificação de Autenticação ---
        const authToken = localStorage.getItem('authToken');
        const userType = localStorage.getItem('userType');

        if (!authToken || userType !== 'aluno') {
            alert('Acesso negado. Por favor, faça login como aluno.');
            window.location.href = '/login-aluno.html';
            return;
        }

        // --- Carregar Dados do Usuário ---
        try {
            const payload = JSON.parse(atob(authToken.split('.')[1]));
            const response = await fetch(`http://localhost:3000/usuarios/${payload.id}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            if (!response.ok) throw new Error('Sessão inválida ou expirada');

            const apiUserData = await response.json();
            const userData = {
                nome_completo: apiUserData.nome_completo || 'Aluno Exemplo',
                email: apiUserData.email || 'aluno@exemplo.com',
                tipo: apiUserData.tipo || 'aluno',
                matricula: apiUserData.aluno_info?.matricula || 'N/A',
                curso: apiUserData.aluno_info?.curso || 'N/A',
                periodo: apiUserData.aluno_info?.periodo ?? 'N/A'
            };

            // Atualizar UI com dados do usuário
            userNameDisplay.textContent = `Olá, ${userData.nome_completo.split(' ')[0]}!`;
            sidebarUserName.textContent = userData.nome_completo;
            sidebarUserEmail.textContent = userData.email;
            sidebarUserType.textContent = userData.tipo.charAt(0).toUpperCase() + userData.tipo.slice(1);
            homeUserName.textContent = userData.nome_completo;
            homeUserEmail.textContent = userData.email;
            homeUserType.textContent = userData.tipo.charAt(0).toUpperCase() + userData.tipo.slice(1);
            homeUserMatricula.textContent = userData.matricula;
            homeUserCurso.textContent = userData.curso;
            homeUserPeriodo.textContent = userData.periodo;
            document.getElementById('matriculaNum').textContent = userData.matricula;
            document.getElementById('matriculaCurso').textContent = userData.curso;
            document.getElementById('matriculaPeriodo').textContent = userData.periodo;

        } catch (e) {
            console.error('Erro ao decodificar token ou buscar dados:', e);
            alert('Sua sessão é inválida. Faça login novamente.');
            localStorage.clear();
            window.location.href = '/login-aluno.html';
            return;
        }

        // --- Funcionalidade de Logout ---
        logoutBtn.addEventListener('click', () => {
            localStorage.clear();
            alert('Você foi desconectado.');
            window.location.href = '/index.html';
        });

        // --- Navegação entre Seções ---
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetSectionId = link.getAttribute('data-section');
                activateSection(targetSectionId);
            });
        });

        function activateSection(sectionId) {
            sidebarLinks.forEach(item => item.classList.remove('active'));
            document.querySelector(`a[data-section="${sectionId}"]`).classList.add('active');

            contentSections.forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            if (sectionId === 'boletim') {
                loadBoletim();
            }
        }
        
        // --- Carregar Boletim Dinamicamente ---
        async function loadBoletim() {
            boletimTableBody.innerHTML = `<tr><td colspan="6">Carregando notas...</td></tr>`;
            try {
                const response = await fetch('http://localhost:3000/alunos/boletim', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Falha ao carregar boletim');
                
                const notas = await response.json();
                boletimTableBody.innerHTML = '';
                
                if (notas.length > 0) {
                    notas.forEach(item => {
                        const row = document.createElement('tr');
                        const statusClass = `status-${item.status}`;
                        row.innerHTML = `
                            <td>${item.disciplina_nome}</td>
                            <td>${item.nota1 ?? 'N/A'}</td>
                            <td>${item.nota2 ?? 'N/A'}</td>
                            <td>${item.media_final ?? 'N/A'}</td>
                            <td>${item.frequencia ?? 'N/A'}%</td>
                            <td class="${statusClass}">${item.status.charAt(0).toUpperCase() + item.status.slice(1)}</td>
                        `;
                        boletimTableBody.appendChild(row);
                    });
                } else {
                    boletimTableBody.innerHTML = `<tr><td colspan="6">Nenhuma disciplina encontrada em seu boletim.</td></tr>`;
                }
            } catch(e) {
                console.error("Erro ao carregar boletim:", e);
                boletimTableBody.innerHTML = `<tr><td colspan="6">Erro ao carregar suas notas.</td></tr>`;
            }
        }

        // --- Funcionalidade de Alterar Senha ---
        const formAlterarSenha = document.getElementById('formAlterarSenha');
        const senhaMessage = document.getElementById('senhaMessage');
        formAlterarSenha.addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            senhaMessage.style.display = 'none';
            if (newPassword !== confirmNewPassword) {
                senhaMessage.textContent = 'A nova senha e a confirmação não coincidem.';
                senhaMessage.className = 'error';
                senhaMessage.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/alterar-senha', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                const data = await response.json();
                senhaMessage.className = response.ok ? 'success' : 'error';
                senhaMessage.textContent = data.message || data.error;
                if (response.ok) formAlterarSenha.reset();
            } catch (err) {
                senhaMessage.className = 'error';
                senhaMessage.textContent = 'Erro de conexão ao alterar a senha.';
            }
            senhaMessage.style.display = 'block';
        });

        // --- Funcionalidade de Calendário (Existente) ---
        const currentMonthYearSpan = document.getElementById('currentMonthYear');
        const calendarGrid = document.querySelector('#calendario .calendar-grid');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        const renderCalendar = (month, year) => {
            calendarGrid.innerHTML = '';
            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            dayNames.forEach(day => {
                const div = document.createElement('div');
                div.classList.add('calendar-day-name');
                div.textContent = day;
                calendarGrid.appendChild(div);
            });
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay();
            for (let i = 0; i < firstDayOfWeek; i++) {
                calendarGrid.appendChild(document.createElement('div'));
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const div = document.createElement('div');
                div.classList.add('calendar-date', 'current-month');
                div.textContent = day;
                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    div.classList.add('today');
                }
                calendarGrid.appendChild(div);
            }
            currentMonthYearSpan.textContent = new Date(year, month).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
        };
        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar(currentMonth, currentYear);
        });
        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            renderCalendar(currentMonth, currentYear);
        });
        renderCalendar(currentMonth, currentYear);
        
        // Carrega o boletim na primeira vez
        loadBoletim();
    });
</script>
</body>
</html>